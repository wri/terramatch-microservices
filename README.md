# terramatch-microservices
Repository for the Microservices API backend of the TerraMatch service

# Requirements:
 * Node v20.11.1. Using [NVM](https://github.com/nvm-sh/nvm?tab=readme-ov-file) is recommended.
 * [Docker](https://www.docker.com/)
 * [CDK CLI](https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html) (install globally)
 * [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html)
 * [NX](https://nx.dev/getting-started/installation#installing-nx-globally) (install globally)
 * [NestJS](https://docs.nestjs.com/) (install globally, useful for development)

# Building and starting the apps
 * Copy `.env.local.sample` to `.env`
 * The ApiGateway does not hot-reload and needs to be re-built when there are changes:
   * `nx build api-gateway` or `nx run-many -t build` (to build all apps)
   * This will build the local proxy Lambda function and the CDK Stack
 * To run all services:
   * `nx run-many -t serve`
   * Note: the first time this runs, the gateway will take quite awhile to start. It'll be faster on subsequent starts.
   * For now, this starts up the ApiGateway and the User service
 * In `.env` in your `wri-terramatch-website` repository, set your BE connection URL correctly:
   * `NEXT_PUBLIC_API_BASE_URL='http://localhost:4000'`

# Deployment
TBD. The ApiGateway has been tested to be at least functional on AWS. Tooling around deployment will be
handled in a future ticket.

# Database work
For now, Laravel is the source of truth for all things related to the DB schema. As such, TypeORM is not allowed to modify the 
schema, and is expected to interface with exactly the schema that is managed by Laravel. This note is included in user.entity.ts, 
and should hold true for all models created in this codebase until this codebase can take over as the source of truth for DB
schema:
```
// Note: this has some additional typing information (like width: 1 on bools and type: timestamps on
//   CreateDateColumn) to make the types generated here match what is generated by Laravel exactly.
//   At this time, we want TypeORM to expect exactly the same types that PHP uses by default. Tested
//   by checking what schema gets generated in the test database against the real DB during unit
//   test runs (the only time we let TypeORM modify the DB schema).
```

This codebase connects to the database running in the `wri-terramatch-api` docker container. The docker-compose
file included in this repo is used only for setting up the database needed for running unit tests in Github Actions.

